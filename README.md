# @occtwasm/core

OpenCascade (OCCT) compiled to WebAssembly with TypeScript bindings.

## Status

Work in progress. See [plans/PLAN.md](plans/PLAN.md) for the full implementation plan.

| Phase | Description | Status |
|-------|-------------|--------|
| **A** | Project scaffolding (package.json, tsconfig, Makefile, Dockerfile) | Done |
| **B** | Download + build scripts (download-occt.sh, build-wasm.sh, CMakeLists.txt) | Done |
| **C** | Codegen config + tool (YAML configs, TypeScript codegen) | Done |
| **D** | Manual binding helpers (cast_helpers.cpp, module-loader.ts, types.ts) | Done |
| **E** | Run codegen + compile WASM | Pending |
| **F** | NPM entry point + TS build | Pending |
| **G** | Tests (vitest) | Pending |

## Architecture

```
C++ OCCT Libraries (.a)
        |
  [embind C++ layer]        ← disambiguated names (e.g. Mirror_Pnt, Mirror_Ax1)
  (generated/ + manual/)      generated from YAML configs + hand-written helpers
        |
    WASM Module (.wasm + .js glue)
        |
  [TypeScript wrapper layer] ← proper overloads with instanceof dispatch
  (generated/ + manual/)      generated TS wrappers + module loader / types
        |
    NPM Package (@occtwasm/core)
```

**Why two layers?** Emscripten's embind only supports overloading by argument *count*, while OCCT heavily overloads by *type* (e.g. `gp_Trsf::SetMirror(gp_Pnt)` vs `SetMirror(gp_Ax1)` vs `SetMirror(gp_Ax2)`). The C++ layer disambiguates with suffixed names; the TypeScript layer restores the original API with runtime `instanceof` dispatch.

## Quick Start

```typescript
import { initOCCT, gp_Pnt, gp_Trsf, gp_Ax1, gp_Dir } from '@occtwasm/core';

await initOCCT();

const origin = new gp_Pnt(0, 0, 0);
const p = new gp_Pnt(1, 2, 3);
const dist = origin.Distance(p);

const trsf = new gp_Trsf();
trsf.SetMirror(origin);                              // Mirror(gp_Pnt)
trsf.SetMirror(new gp_Ax1(origin, new gp_Dir(0,0,1))); // Mirror(gp_Ax1)
```

## Building from Source

### Prerequisites

- Docker (for Emscripten toolchain)
- Node.js >= 18
- npm

### Build Steps

```bash
npm install          # Install TS dependencies
make download        # Download OCCT source
make build-occt      # Build OCCT static libs (Docker)
make codegen         # Generate embind C++ and TS wrappers
make build-bindings  # Compile WASM module (Docker)
npm run build        # Build TypeScript package
npm test             # Run tests
```

## Project Structure

```
scripts/                        # Download and build scripts (Docker-based)
codegen/                        # YAML configs + TypeScript code generator
  config/                       # Per-toolkit binding declarations (TKMath.yaml, TKBRep.yaml, ...)
  src/                          # Codegen tool source
bindings/
  generated/                    # Auto-generated by `npm run codegen` — DO NOT EDIT
    cpp/                        #   embind C++ (one file per OCCT toolkit)
    ts/                         #   TypeScript wrappers with runtime overload dispatch
  manual/                       # Hand-written code — safe to edit, never overwritten by codegen
    cpp/                        #   C++ helpers compiled alongside generated bindings
      occt_wasm_init.cpp        #     Module-level init (version string, etc.)
      cast_helpers.cpp          #     TopoDS downcasting (TopoDS_ToVertex, TopoDS_ToEdge, ...)
    ts/                         #   TypeScript utilities imported by the package entry point
      types.ts                  #     OcctModule interface, InitOptions, CastHelper type
      module-loader.ts          #     Async initOCCT() — singleton WASM loader
src/                            # NPM package entry point
tests/                          # Vitest test suite
swig/                           # Reference SWIG interface files
build/                          # Build artefacts (gitignored)
  occt-install/                 #   Pre-built OCCT static libraries
  dist/                         #   occt.js + occt.wasm output
```

### Why `generated/` vs `manual/`?

Both directories are compiled together into the final WASM module, but they have different ownership:

- **`bindings/generated/`** is overwritten every time `npm run codegen` runs. Any hand-edits here will be lost.
- **`bindings/manual/`** is never touched by codegen. It holds code that cannot be derived from the YAML configs — such as the `TopoDS` downcasting helpers (static C++ functions) and the TypeScript module loader (async WASM init with environment detection).

The build scripts (`build-bindings.sh` for Docker, `CMakeLists.txt` for CMake) collect `.cpp` files from both directories and link them into a single `occt.wasm`.

## Initial Scope

~25 classes from gp (geometric primitives) and TopoDS (topological data structure):

- **gp**: Pnt, Vec, Dir, Ax1, Ax2, Ax3, Trsf, Mat, Quaternion, XYZ, Lin, Pln, Circ, Elips
- **TopoDS**: Shape, Vertex, Edge, Wire, Face, Shell, Solid, Compound, Builder, Iterator
- **TopExp**: Explorer
- **BRep**: Builder, Tool

## License

LGPL-2.1 (same as OCCT)
